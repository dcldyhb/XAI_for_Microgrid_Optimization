# This file is auto-generated by PySR.
import numpy as np
import torch
import sys
import os

# --- Math Safety Functions ---
def safe_sqrt(x): return np.sqrt(np.abs(x))
def safe_div(a, b): return np.divide(a, b + 1e-9)
def safe_log(x): return np.log(np.abs(x) + 1e-9)

# --- Path Configuration ---
current_dir = os.path.dirname(os.path.abspath(__file__))
project_root = os.path.dirname(os.path.dirname(current_dir))
if project_root not in sys.path: sys.path.append(project_root)
try: from config import DEVICE
except ImportError: DEVICE = torch.device('cpu')

class GeneratedGammaCalculator:
    def __init__(self):
        np.seterr(all='ignore')
        self.feature_names = ['temperature', 'wind_speed', 'solar_irradiance', 'precipitation_mm', 'elec_vmin', 'elec_vmax', 'elec_vavg', 'elec_line_loading_max', 'elec_line_loading_top1', 'elec_line_loading_top2', 'elec_line_loading_top3', 'elec_vmax_nonslack', 'elec_line_i_ka_max', 'elec_p_loss_mw', 'elec_soc_1', 'elec_soc_2', 'elec_soc_3', 'elec_soc_4', 'elec_soc_5', 'elec_any_violate', 'elec_violate_v', 'elec_violate_line', 'grid_load_demand', 'hour_of_day', 'day_of_week']
        self.gamma_signals = ['yhat_ess1_up', 'yhat_ess1_down', 'yhat_ess2_up', 'yhat_ess2_down', 'yhat_ess3_up', 'yhat_ess3_down', 'yhat_ess4_up', 'yhat_ess4_down', 'yhat_ess5_up', 'yhat_ess5_down', 'yhat_sop1_fwd', 'yhat_sop1_rev', 'yhat_sop2_fwd', 'yhat_sop2_rev', 'yhat_pv1', 'yhat_pv2', 'yhat_pv3', 'yhat_pv4', 'yhat_pv5', 'yhat_pv6', 'yhat_wt1', 'yhat_wt2', 'yhat_wt3', 'yhat_wt4', 'yhat_wt5', 'yhat_wt6']

    def compute(self, state):
        # Unpack features based on training configuration
        x0 = state[0] # temperature
        x1 = state[1] # wind_speed
        x2 = state[2] # solar_irradiance
        x3 = state[3] # precipitation_mm
        x4 = state[4] # elec_vmin
        x5 = state[5] # elec_vmax
        x6 = state[6] # elec_vavg
        x7 = state[7] # elec_line_loading_max
        x8 = state[8] # elec_line_loading_top1
        x9 = state[9] # elec_line_loading_top2
        x10 = state[10] # elec_line_loading_top3
        x11 = state[11] # elec_vmax_nonslack
        x12 = state[12] # elec_line_i_ka_max
        x13 = state[13] # elec_p_loss_mw
        x14 = state[14] # elec_soc_1
        x15 = state[15] # elec_soc_2
        x16 = state[16] # elec_soc_3
        x17 = state[17] # elec_soc_4
        x18 = state[18] # elec_soc_5
        x19 = state[19] # elec_any_violate
        x20 = state[20] # elec_violate_v
        x21 = state[21] # elec_violate_line
        x22 = state[22] # grid_load_demand
        x23 = state[23] # hour_of_day
        x24 = state[24] # day_of_week

        # Formulas
        gamma_0 = x19
        gamma_1 = safe_sqrt(x20)
        gamma_2 = np.square(x20)
        gamma_3 = x19 + ((x19 / (x14 - np.square((x8 + 0.4807294) - (x14 * 1.3929163)))) / 0.9259921)
        gamma_4 = x20 + np.abs(np.square((x19 * 0.3418984) + ((((1.0582619 / x6) - 1.2214626) + x12) * -4.724853)) / np.abs(safe_sqrt(x12)))
        gamma_5 = np.abs(((0.46377304 / ((0.46377304 * x10) - (x20 / (x12 / 3.7431345)))) - 1.0598879) * x19)
        gamma_6 = x20 + (x8 / np.square(((x6 * (x17 / 0.21958663)) - (x8 + ((x17 - (x20 / np.abs(-0.047591332 / x16))) + x7))) - 1.2018304))
        gamma_7 = (x12 * x20) * safe_sqrt(x23 + 3.1349056)
        gamma_8 = x19 + np.abs(safe_sqrt(x10) / (((x19 + 0.22754987) * x22) + (((2.6383564 - (x10 - x15)) * x15) * -0.5227047)))
        gamma_9 = x20 - (0.40040523 * np.square(x20 * (0.40040523 / ((x7 * 0.6583265) - x17))))
        gamma_10 = np.abs(safe_sqrt(np.abs(0.18837182 - x13)) * (x13 - (x20 * 2.114027)))
        gamma_11 = (3.1770074 - (163.06245 / x7)) - x13
        gamma_12 = (x19 * x23) / np.abs(x13 / ((-1.2840545 / x6) + 1.3180605))
        gamma_13 = x8 * 0.010850728
        gamma_14 = x19
        gamma_15 = x19
        gamma_16 = x19
        gamma_17 = x19
        gamma_18 = x20
        gamma_19 = safe_sqrt(x20 * np.abs((21.028105 / x11) + -20.065475))
        gamma_20 = x19
        gamma_21 = x19
        gamma_22 = x20
        gamma_23 = x20
        gamma_24 = safe_sqrt(x20)
        gamma_25 = x19

        # Output Assembly
        gamma_values = [gamma_0, gamma_1, gamma_2, gamma_3, gamma_4, gamma_5, gamma_6, gamma_7, gamma_8, gamma_9, gamma_10, gamma_11, gamma_12, gamma_13, gamma_14, gamma_15, gamma_16, gamma_17, gamma_18, gamma_19, gamma_20, gamma_21, gamma_22, gamma_23, gamma_24, gamma_25]
        # 数值清洗: 替换 NaN/Inf 为 0
        gamma_array = np.nan_to_num(np.array(gamma_values, dtype=np.float32), nan=0.0, posinf=0.0, neginf=0.0)
        return torch.from_numpy(gamma_array).to(DEVICE).unsqueeze(0)